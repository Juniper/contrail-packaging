#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.
# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1

SPEC_DIR := $(shell pwd)
export SB_TOP := $(shell pwd | sed -re "s/(.*)\/tools\/packaging\/(.*)/\1/")

export BUILDTIME := $(shell date -u +%y%m%d%H%M)
export buildroot := $(SB_TOP)/build/debian/contrail-config-venv
export installroot := $(SB_TOP)/build/debian/contrail-config-venv-tmp
export sedpattern := $(subst /,\/,$(buildroot))
#export LD_LIBRARY_PATH := $(LD_LIBRARY_PATH):$(SB_TOP)/build/debian/contrail-libs/usr/lib64/contrail

_srcdir = ${SB_TOP}/distro/python-venv-packaging
export _target := /opt/contrail/api-venv
export _venvdist = $(SB_TOP)/build/third_party
export _venvdir = virtualenv-1.9.1

reqlist := greenlet-0.4.1.zip gevent-0.13.8.tar.gz eventlet-0.9.17.tar.gz lxml-2.3.3.tar.gz geventhttpclient-1.0a.tar.gz netaddr-0.7.5.zip extras-0.0.3.tar.gz requests-1.1.0.tar.gz wsgiref-0.1.2.zip zope.interface-3.8.0.tar.gz netifaces-0.8.tar.gz pycrypto-2.6.tar.gz paramiko-1.11.0.tar.gz Fabric-1.7.0.tar.gz bitarray-0.8.0.tar.gz thrift-0.8.0.tar.gz psutil-1.0.1.tar.gz iso8601-0.1.4.tar.gz prettytable-0.7.2.zip simplejson-3.3.0.tar.gz argparse-1.2.1.tar.gz oslo.config-1.1.1.tar.gz d2to1-0.2.11.tar.gz pyparsing-1.5.7.tar.gz cmd2-0.6.5.1.tar.gz cliff-1.4.4.tar.gz httplib2-0.8.tar.gz repoze.lru-0.6.tar.gz Paste-1.7.5.1.tar.gz PasteDeploy-1.5.0.tar.gz SQLAlchemy-0.8.2.tar.gz Routes-1.13.tar.gz qpid-python-0.20.tar.gz stevedore-0.12.tar.gz pbr-0.5.21.tar.gz WebOb-1.2.3.tar.gz

ifdef $(__python_path)
_lpy := $(__python_path)
_vpy := --python=$(_lpy)/bin/python
_pyprefix := /usr
_pyver := 2.7
endif

BUILDTAG =
ifdef TAG
BUILDTAG = $(TAG)
else
BUILDTAG = $(BUILDTIME)
endif

%:
	dh $@ --tmpdir=${installroot} --destdir=${SB_TOP}/build/debian

override_dh_auto_build:
	cat debian/changelog.in | sed 's,BUILDTAG,$(BUILDTAG),g' > debian/changelog
	mkdir -p ${_venvdist}
	(cd ${_venvdist} && tar xzvf $(_srcdir)/archives/virtualenv-1.9.1.tar.gz)

#	TODO: building the venv should be an scons target that can be used
#	by unit tests also.

#	Create requirements file
	mkdir -p ${buildroot}/$(_venvdir)/reqs
	rm -f ${buildroot}/$(_venvdir)/reqs/reqs.txt
	for x in $(reqlist); do echo $(_srcdir)/archives/$$x >> ${buildroot}/$(_venvdir)/reqs/reqs.txt; done

#	build the venv
	$(__python) $(_venvdist)/$(_venvdir)/virtualenv.py $(_vpy) --extra-search-dir=$(buildroot)/$(_venvdir)/reqs --extra-search-dir=$(_venvdist)/$(_venvdir)/virtualenv_support --never-download --system-site-packages $(buildroot)$(_target)
	cd $(buildroot)$(_target); bash -xc "source bin/activate && \
           bin/python bin/pip install --index-url='' --requirement \
           $(buildroot)/$(_venvdir)/reqs/reqs.txt \
	   && deactivate"

	(cd ${SB_TOP}/distro/third_party/pycassa-1.10.0; \
	 bash -xc "source $(buildroot)$(_target)/bin/activate && \
           $(buildroot)$(_target)/bin/python setup.py install && \
	   deactivate")

	(cd ${SB_TOP}/distro/third_party/xmltodict-0.7.0; \
	 bash -xc "source $(buildroot)$(_target)/bin/activate && \
           $(buildroot)$(_target)/bin/python setup.py install && \
	   deactivate")

	(cd ${SB_TOP}/distro/third_party/redis-2.8.0; \
	 bash -xc "source $(buildroot)$(_target)/bin/activate && \
           $(buildroot)$(_target)/bin/python setup.py install && \
	   deactivate")


override_dh_auto_install:
#	Setup directories
	install -m 755 -d $(installroot)$(_target)
	cp -r $(buildroot)$(_target) $(installroot)/opt/contrail

	(cd $(installroot); for f in $$(find opt/contrail/api-venv -type f -exec grep -nH $(buildroot) {} \; | grep -v 'Binary file' | cut -d: -f1); do sed -i 's/$(sedpattern)//g' $$f && echo "changed $$f ..." ; done)
#	cd $(_builddir); rm -rf virtualenv-1.9.1

#	modify symlinks
	for f in $$(find $(_target) -type l -print ); \
		do x=$$(pwd); cd $$(dirname $$f); \
		F=$$(basename $$f); p=$$(readlink $$F); rm -f $$F; \
		cp -ar $$p $$F; cd $$x ; done
#	cp -fr $(_lpy)/lib/python$(_pyver)/* $(_target)/lib/python$(_pyver)
	find $(_target) -name '*.py[oc]' | xargs rm -f

override_dh_shlibdeps: 

override_dh_usrlocal:	

